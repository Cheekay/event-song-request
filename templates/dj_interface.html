{% extends "base.html" %}

{% block content %}
<div class="container-fluid px-3 py-4">
    <h1 class="mb-4 fs-4">DJ Interface - Manage Playlist</h1>
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th class="d-none d-md-table-cell">Song Title</th>
                    <th class="d-none d-md-table-cell">Artist</th>
                    <th class="d-none d-md-table-cell">Requester</th>
                    <th>Requests</th>
                    <th class="d-none d-sm-table-cell">Last Requested</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="dj_song_list">
                {% for song in songs %}
                <tr>
                    <td class="d-none d-md-table-cell text-break">{{ song.song_title }}</td>
                    <td class="d-none d-md-table-cell text-break">{{ song.artist_name }}</td>
                    <td class="d-none d-md-table-cell text-break">{{ song.username }}</td>
                    <td>{{ song.count }}</td>
                    <td class="d-none d-sm-table-cell">{{ song.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>
                        <button class="btn btn-danger btn-sm remove-song w-100" data-song-id="{{ song.id }}">Remove</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const songList = document.getElementById('dj_song_list');
    songList.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-song')) {
            const songId = e.target.getAttribute('data-song-id');
            removeSong(songId);
        }
    });

    setupWebSocket();
});

function setupWebSocket() {
    const socket = io();
    socket.on('song_list_updated', function() {
        location.reload();
    });
}

function removeSong(songId) {
    fetch(`/remove_song/${songId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const row = document.querySelector(`button[data-song-id="${songId}"]`).closest('tr');
                row.remove();
            } else {
                alert('Failed to remove song');
            }
        });
}
</script>
{% endblock %}
