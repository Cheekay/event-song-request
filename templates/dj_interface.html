{% extends "base.html" %}

{% block content %}
<div class="container-fluid px-3 py-4">
    <h1 class="mb-4 fs-4">DJ Interface - Manage Playlist</h1>
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Song Title</th>
                    <th>Artist</th>
                    <th class="d-none d-md-table-cell">Requester</th>
                    <th>Requests</th>
                    <th class="d-none d-md-table-cell">Last Requested</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="dj_song_list">
                {% for song in songs %}
                <tr>
                    <td class="text-break">{{ song.song_title }}</td>
                    <td class="text-break">{{ song.artist_name }}</td>
                    <td class="d-none d-md-table-cell text-break">{{ song.username }}</td>
                    <td>{{ song.count }}</td>
                    <td class="d-none d-md-table-cell">{{ song.timestamp.strftime('%m-%d %H:%M') }}</td>
                    <td>
                        <button class="btn btn-danger btn-sm remove-song" data-song-id="{{ song.id }}">Remove</button>
                        <button class="btn btn-sm btn-outline-secondary d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#details-{{ loop.index }}" aria-expanded="false" aria-controls="details-{{ loop.index }}">
                            More Details
                        </button>
                    </td>
                </tr>
                <tr class="d-md-none">
                    <td colspan="6">
                        <div class="collapse" id="details-{{ loop.index }}">
                            <div class="card card-body">
                                <p><strong>Requester:</strong> {{ song.username }}</p>
                                <p><strong>Last Requested:</strong> {{ song.timestamp.strftime('%m-%d %H:%M') }}</p>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const songList = document.getElementById('dj_song_list');
    songList.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-song')) {
            const songId = e.target.getAttribute('data-song-id');
            removeSong(songId);
        }
    });

    setupWebSocket();
});

function setupWebSocket() {
    const socket = io();
    socket.on('song_list_updated', function() {
        location.reload();
    });
}

function removeSong(songId) {
    fetch(`/remove_song/${songId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const row = document.querySelector(`button[data-song-id="${songId}"]`).closest('tr');
                const detailsRow = row.nextElementSibling;
                row.remove();
                if (detailsRow && detailsRow.classList.contains('d-md-none')) {
                    detailsRow.remove();
                }
            } else {
                alert('Failed to remove song');
            }
        });
}
</script>
{% endblock %}
