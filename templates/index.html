{% extends "base.html" %}

{% block content %}
<div class="row g-4">
    <div class="col-12 col-lg-4 mb-4">
        <h2 class="mb-3 fs-4">Submit a Song Request</h2>
        <form id="song-request-form" action="{{ url_for('submit_request') }}" method="post">
            <div class="mb-3">
                <label for="song_title" class="form-label">Song Title</label>
                <input type="text" class="form-control" id="song_title" name="song_title" required>
                <div id="song_suggestions" class="list-group mt-2"></div>
            </div>
            <div class="mb-3">
                <label for="artist_name" class="form-label">Artist Name</label>
                <input type="text" class="form-control" id="artist_name" name="artist_name" required>
            </div>
            <div class="mb-3">
                <label for="username" class="form-label">Your Name</label>
                <input type="text" class="form-control" id="username" name="username" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Submit Request</button>
        </form>
    </div>
    <div class="col-12 col-lg-8">
        <h2 class="mb-3 fs-4">Requested Songs</h2>
        <div class="mb-3">
            <label for="sort_select" class="form-label">Sort by:</label>
            <select id="sort_select" class="form-select" onchange="updateSongList()">
                <option value="count">Popularity</option>
                <option value="timestamp">Most Recent</option>
            </select>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Song Title</th>
                        <th>Artist</th>
                        <th class="d-none d-md-table-cell">Requester</th>
                        <th>Requests</th>
                        <th class="d-none d-md-table-cell">Last Requested</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="song_list">
                    <!-- Song list will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    setupWebSocket();
    updateSongList();

    const form = document.getElementById('song-request-form');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        submitSongRequest();
    });

    const songTitleInput = document.getElementById('song_title');
    songTitleInput.addEventListener('input', debounce(searchSongs, 300));
});

function setupWebSocket() {
    const socket = io();
    socket.on('song_list_updated', function() {
        updateSongList();
    });
}

function updateSongList() {
    const songListElement = document.getElementById('song_list');
    const sortSelect = document.getElementById('sort_select');
    const sortBy = sortSelect.value;
    
    fetch(`/get_song_list?sort_by=${sortBy}`)
        .then(response => response.json())
        .then(songs => {
            songListElement.innerHTML = '';
            
            songs.forEach((song, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-break">${song.title}</td>
                    <td class="text-break">${song.artist}</td>
                    <td class="d-none d-md-table-cell text-break">${song.username}</td>
                    <td>${song.count}</td>
                    <td class="d-none d-md-table-cell">${song.timestamp}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#details-${index}" aria-expanded="false" aria-controls="details-${index}">
                            More Details
                        </button>
                    </td>
                `;
                songListElement.appendChild(row);

                const detailsRow = document.createElement('tr');
                detailsRow.className = 'd-md-none';
                detailsRow.innerHTML = `
                    <td colspan="6">
                        <div class="collapse" id="details-${index}">
                            <div class="card card-body">
                                <p><strong>Requester:</strong> ${song.username}</p>
                                <p><strong>Last Requested:</strong> ${song.timestamp}</p>
                            </div>
                        </div>
                    </td>
                `;
                songListElement.appendChild(detailsRow);
            });
        });
}

function submitSongRequest() {
    const form = document.getElementById('song-request-form');
    const formData = new FormData(form);

    fetch('/submit_request', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            form.reset();
            updateSongList();
        } else {
            alert('Failed to submit song request');
        }
    });
}

function searchSongs() {
    const query = document.getElementById('song_title').value;
    if (query.length < 3) {
        document.getElementById('song_suggestions').innerHTML = '';
        return;
    }

    fetch(`/search_songs?query=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const suggestionsElement = document.getElementById('song_suggestions');
            suggestionsElement.innerHTML = '';
            data.forEach(song => {
                const item = document.createElement('a');
                item.href = '#';
                item.classList.add('list-group-item', 'list-group-item-action');
                item.textContent = `${song.title} - ${song.artist}`;
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('song_title').value = song.title;
                    document.getElementById('artist_name').value = song.artist;
                    suggestionsElement.innerHTML = '';
                });
                suggestionsElement.appendChild(item);
            });
        })
        .catch(error => {
            console.error('Error searching songs:', error);
        });
}

function debounce(func, delay) {
    let timeoutId;
    return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(context, args), delay);
    };
}
</script>
{% endblock %}
